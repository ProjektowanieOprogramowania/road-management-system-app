<!--<p-dock [model]="dockItems" position="left" class="my-dock w-1rem">-->
<!--  <ng-template pTemplate="item" let-item>-->
<!--    <p onClick="" class="cursor-pointer text-left w-full">{{item.label}}</p>-->
<!--  </ng-template>-->
<!--</p-dock>-->

<p-toast></p-toast>

<div #form class="flex flex-column align-items-center m-3">
  <p class="mt-5 mb-2 text-2xl">
    {{isRoadEdit === true ? "Edytuj drogę" : "Dodaj drogę"}}
  </p>
  <p-divider class="w-full py-0 my-0 px-8"></p-divider>
  <p class="mb-5 mt-2 text-xl">Uzupełnij dane</p>
  <form [formGroup]="roadForm" (ngSubmit)="onSubmit()" class="mb-5 ">
    <div class="field">
      <label for="name" class="block">Nazwa</label>
      <input id="name" type="text"
             class="w-full {{name?.invalid && (name?.dirty || name?.touched) ? 'ng-invalid ng-dirty' : ''}}" pInputText
             formControlName="name"/>
      <ng-container *ngIf="name?.invalid && (name?.dirty || name?.touched)">
        <small *ngIf="name?.errors?.['required']" id="name-help" class="p-error block">Nazwa jest wymagana.</small>
      </ng-container>
    </div>
    <div class="field">
      <label for="sub" class="block">Cena subskrybcji za jeden dzień</label>
      <p-inputNumber formControlName="subscriptionPriceForOneDay" [showButtons]="true" id="sub" mode="currency"
                     currency="PLN" class="w-full"
                     decrementButtonClass="{{subscriptionPriceForOneDay?.value === null
                                              || subscriptionPriceForOneDay!.value! <= 0 ? 'hidden' : ''}}">
      </p-inputNumber>
      <ng-container
        *ngIf="subscriptionPriceForOneDay?.invalid && (subscriptionPriceForOneDay?.dirty || subscriptionPriceForOneDay?.touched)">
        <small *ngIf="subscriptionPriceForOneDay?.errors?.['required']" class="p-error block">Cena subskrybcji za jeden
          dzień jest wymagana.</small>
        <small *ngIf="subscriptionPriceForOneDay?.errors?.['min']" class="p-error block">Cena subskrybcji za jeden dzień
          nie może być ujemna.</small>
      </ng-container>
    </div>
    <div class="w-full flex justify-content-center mt-5">
      <button pButton pRipple type="button" icon="pi pi-arrow-down" class="p-button-rounded" (click)="scroll(map)">
      </button>
    </div>
  </form>

  <p-divider class="w-full py-0 my-0 px-8"></p-divider>
  <div class="w-full flex">
    <div class="table-select-div">
      <div>
        <p class="text-center text-xl">Punkty:</p>
        <p-listbox [options]="roadNodes" [(ngModel)]="selectedNode"
                   optionLabel="name" [listStyle]="{'height':'350px'}">
          <ng-template let-roadNode pTemplate="item">
            <div class="flex w-full">
              <ng-container *ngIf="nodeEditing.has(roadNode.name); else node_span">
                <input [(ngModel)]="nodeNameControl"/>
              </ng-container>

              <ng-template #node_span>
                <span class="flex align-items-center overflow-auto">{{roadNode.name}}</span>
              </ng-template>

              <div class="flex gap-2 ml-auto z-3">
                <ng-container *ngIf="nodeEditing.has(roadNode.name); else node_edit_btn">
                  <button pButton class="p-button-success p-button-sm" (click)="onOkNode(roadNode.name)">Ok</button>
                  <button pButton class="p-button-danger p-button-sm" (click)="onCancelEditNode()">Anuluj</button>
                </ng-container>
                <ng-template #node_edit_btn>
                  <button pButton class="p-button-secondary p-button-sm" (click)="onEditNode(roadNode.name)">Edytuj</button>
                  <button pButton class="p-button-danger p-button-sm" (click)="onDeleteNode(roadNode.name)">Usuń</button>
                </ng-template>

              </div>
            </div>
          </ng-template>
        </p-listbox>
      </div>

      <div>
        <p class="text-center text-xl">Odcinki:</p>
        <p-listbox [options]="roadSegments" [(ngModel)]="selectedSegment"
                   optionLabel="id" [listStyle]="{'height':'350px'}">
          <ng-template let-segment pTemplate="item">
            <div class="flex w-full">

              <span class="flex align-items-center overflow-auto">{{segment.startNode.name +  " -> " + segment.endNode.name}}</span>

              <div class="flex gap-2 ml-auto z-3">
                <button pButton class="p-button-secondary p-button-sm" >Edytuj</button>
                <button pButton class="p-button-danger p-button-sm" (click)="onDeleteSegment(segment.id)">Usuń</button>
              </div>
            </div>
          </ng-template>
        </p-listbox>
      </div>

    </div>
    <div #map [style]="{'height':'95vh'}" class="w-full flex flex-column align-items-center">
      <p class="mb-5 mt-2 text-xl">Dodaj węzły i odcinki</p>
      <div class="flex mb-4 align-items-center">
        <p-toggleButton [ngModel]="isAddingNodesModeOn" onLabel="Dodaj węzły" offLabel="Dodaj węzły"
                        (onChange)="switchAddingNodesMode()"
                        styleClass="p-button-sm mr-3">
        </p-toggleButton>
        <p-toggleButton [ngModel]="isAddingSegmentsModeOn" onLabel="Dodaj odcinki" offLabel="Dodaj odcinki"
                        (onChange)="switchAddingSegmentsMode()"
                        styleClass="p-button-sm mr-3">
        </p-toggleButton>
        <button pButton pRipple type="button" icon="pi pi-arrow-down" class="p-button-rounded" (click)="scroll(save)">
        </button>
      </div>
      <p *ngIf="isAddingNodesModeOn" class="font-semibold">Kliknij na mapę, aby dodać nowy węzeł.</p>
      <ng-container *ngIf="isAddingSegmentsModeOn">
        <p *ngIf="!startSegmentNode" class="font-semibold">Zaznacz węzeł początkowy</p>
        <p *ngIf="startSegmentNode" class="font-semibold mb-0">
          <span class="font-normal">Węzeł początkowy:</span> {{this.startSegmentNode.name}}</p>
        <p *ngIf="startSegmentNode && !endSegmentNode" class="font-semibold">Zaznacz węzeł końcowy</p>
        <p *ngIf="endSegmentNode" class="font-semibold">
          <span class="font-normal">Węzeł końcowy:</span> {{this.endSegmentNode.name}}
        </p>
        <ng-container *ngIf="endSegmentNode && startSegmentNode">
          <p class="font-semibold">Wybierz taryfikator</p>
          <p-dropdown [options]="tariffs" [(ngModel)]="selectedTariff" optionLabel="name" class="mb-3 w-8"></p-dropdown>
          <button pButton type="button" label="Dodaj odcinek" icon="pi pi-plus"
                  class="mb-4" (click)="addSegment()">
          </button>
        </ng-container>
      </ng-container>
      <p-gmap [options]="mapOptions" class="w-full h-full"
              [style]="{'width':'100%','height':'100%'}"
              [overlays]="mapOverlays"
              (onMapClick)="handleMapClick($event)"
              (onOverlayClick)="handleOverlayClick($event)"
              (onOverlayDragEnd)="handleOverlayDragEnd($event)"
              (onOverlayDrag)="handleOverlayDrag($event)"
              #gMap
      >
      </p-gmap>
    </div>
  </div>

  <p-divider class="w-full py-0 my-0 px-8"></p-divider>
  <div #save class=" flex flex-column align-items-center">
    <p class="mb-5 mt-2 text-xl">Zapisz drogę</p>
    <p-button styleClass="mb-8">Zapisz</p-button>
    <button pButton pRipple type="button" icon="pi pi-arrow-up" class="p-button-rounded mb-5" (click)="scroll(form)">
    </button>
  </div>
</div>

<p-dialog showEffect="fade" [(visible)]="addNodePopupOpen" header="Nowy węzeł drogowy" [style]="{width: '400px'}"
          (onHide)="onAddNodePopupHide()">
  <div class="grid p-fluid" *ngIf="selectedPosition">
    <div class="col-2 align-self-center"><label for="node-name">Nazwa</label></div>
    <div class="col-10"><input type="text" pInputText id="node-name" [(ngModel)]="nodeName"></div>
    <div class="col-2"></div>
    <small *ngIf="nodeNameError" class="p-error block col-10">{{nodeNameError}}</small>
  </div>
  <ng-template pTemplate="footer">
    <div>
      <button type="button" pButton label="Dodaj węzeł" icon="pi pi-plus" (click)="addMarker()"></button>
    </div>
  </ng-template>
</p-dialog>
